<div
  class="document-edit-page"
  [class.rtl]="isRTL"
  [attr.dir]="isRTL ? 'rtl' : 'ltr'"
  >
  <!-- Header with back arrow, title, tags, and action buttons -->
  <div class="page-header">
    <div class="header-left">
      <button mat-icon-button class="back-button" (click)="onCancel()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <h2 class="page-title" [class.arabic-font]="isRTL">
        {{ "documents.edit.title" | translate }}
      </h2>
    </div>

    <div class="header-tags">
      <span class="tag status-tag">{{ "statuses." + currentDocument?.status | translate }}</span>
      <span class="tag priority-tag">{{ "priorities." + currentDocument?.priority | translate }}</span>
      <span class="tag department-tag">{{ "departments." + (isRTL ? currentDocument?.department_ar! : currentDocument?.department_en! | translate) }}</span>
    </div>

    <div class="header-actions">
      <!-- Comments Button - Only visible for users with comment permission and disabled for signed documents -->
      <button mat-button class="comments-button"
        *appHasPermission="{ permission: 'comment', document: currentDocument }"
        (click)="onComments()">
        <mat-icon>chat_bubble_outline</mat-icon>
        {{ "common.comments" | translate:{count: commentCount} }}
      </button>

      <!-- Cancel Button - Always visible -->
      <button mat-button (click)="onCancel()" class="cancel-button">
        <mat-icon>close</mat-icon>
        {{ "common.cancel" | translate }}
      </button>

      <!-- Save Button - Only enabled for users with edit permission and disabled for signed documents -->
      <button
        mat-raised-button
        color="primary"
        (click)="onSubmit()"
        [disabled]="editForm.invalid || isSubmitting"
        [appPermissionDisable]="{ permission: 'edit', document: currentDocument, inverse: true }"
        class="save-button">
        <mat-icon>check</mat-icon>
        {{ "common.saveChanges" | translate }}
      </button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="page-content">
    <!-- Left Panel - Edit Form -->
    <div class="edit-form-panel">
      <h3 class="panel-title" [class.arabic-font]="isRTL">
        {{ "documents.edit.editDocument" | translate }}
      </h3>

      <form [formGroup]="editForm" class="document-form">
        <!-- Document Title -->
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>{{ "documents.form.title" | translate }} *</mat-label>
          <input
            matInput
            formControlName="title"
            [placeholder]="'documents.form.titlePlaceholder' | translate"
            />
            @if (editForm.get('title')?.hasError('required')) {
              <mat-error>
                {{ "documents.create.validation.required" | translate }}
              </mat-error>
            }
            @if (editForm.get('title')?.hasError('maxlength')) {
              <mat-error>
                {{ "documents.create.validation.maxLength" | translate }}
              </mat-error>
            }
          </mat-form-field>

          <!-- Department and Priority in one row -->
          <div class="flex-row-container">
            <mat-form-field appearance="outline" class="form-field mr-2">
              <mat-label>{{ "documents.form.department" | translate }}</mat-label>
              <mat-select formControlName="fromDepartment">
                @for (dept of departments; track dept) {
                  <mat-option [value]="dept.id.toString()">
                    {{ isRTL ? dept.name_ar : dept.name_en }}
                  </mat-option>
                }
              </mat-select>
              @if (editForm.get('fromDepartment')?.hasError('required')) {
                <mat-error>
                  {{ "documents.create.validation.required" | translate }}
                </mat-error>
              }
            </mat-form-field>

            <!-- Priority -->
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ "documents.form.priority" | translate }}</mat-label>
              <mat-select formControlName="priority">
                <mat-option value="low">{{ 'priorities.low' | translate }}</mat-option>
                <mat-option value="medium">{{ 'priorities.medium' | translate }}</mat-option>
                <mat-option value="high">{{ 'priorities.high' | translate }}</mat-option>
              </mat-select>
              @if (editForm.get('priority')?.hasError('required')) {
                <mat-error>
                  {{ "documents.create.validation.required" | translate }}
                </mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Document Description -->
          <div class="description-field">
            <label class="field-label" for="description-textarea">{{ "documents.form.description" | translate }} *</label>
            <textarea
              id="description-textarea"
              class="description-textarea"
              formControlName="description"
              rows="5"
              [placeholder]="'documents.form.descriptionPlaceholder' | translate"
            ></textarea>
          </div>

          <!-- Current Files Section -->
          <div class="current-file-section">
            <h4 class="section-title" [class.arabic-font]="isRTL">
              {{ "documents.edit.currentFiles" | translate }} ({{ currentDocument?.attachments?.length || 0 }})
            </h4>
            @if (!currentDocument?.attachments?.length) {
              <div class="current-file-display no-file">
                <mat-icon class="file-icon no-file-icon">
                  cloud_off
                </mat-icon>
                <div class="file-info">
                  <span class="file-name no-file-text">
                    No files uploaded
                  </span>
                </div>
              </div>
            } @else {
              @for (attachment of currentDocument?.attachments; track attachment.id) {
                <div class="current-file-display">
                  <mat-icon class="file-icon">
                    {{ getFileIcon(attachment.original_name || '') }}
                  </mat-icon>
                  <div class="file-info">
                    <span class="file-name">
                      {{ attachment.original_name || 'Unknown file' }}
                    </span>
                    <div class="file-actions">
                      <button mat-button color="primary" (click)="viewAttachment(attachment)" class="view-file-button">
                        <mat-icon>visibility</mat-icon>
                        {{ 'documents.edit.viewFile' | translate }}
                      </button>
                      <button mat-button color="accent" (click)="downloadAttachment(attachment)" class="download-file-button">
                        <mat-icon>download</mat-icon>
                        {{ 'common.download' | translate }}
                      </button>
                    </div>
                  </div>
                </div>
              }
            }

          <!-- Upload New File Section -->
          <div class="upload-new-file-section">
            <h4 class="section-title" [class.arabic-font]="isRTL">
              {{ "documents.edit.uploadNewFile" | translate }}
            </h4>
            <div class="file-upload-container">
              <div class="file-upload-area">
                <input
                  type="file"
                  #fileInput
                  accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                  class="file-input"
                  (change)="onFileSelected($event)"
                  />
                  <div class="upload-content">
                    <button
                      type="button"
                      mat-stroked-button
                      color="primary"
                      (click)="fileInput.click()"
                      class="choose-file-btn">
                      {{ "documents.edit.chooseFile" | translate }}
                    </button>
                    <span class="no-file-text" [class.arabic-font]="isRTL">
                      {{ selectedFile ? selectedFile.name : ('documents.edit.noFileChosen' | translate) }}
                    </span>
                  </div>
                </div>

                <!-- File Validation Error -->
                @if (fileError) {
                  <div
                    class="error-message"
                    [class.arabic-font]="isRTL"
                    >
                    {{ fileError }}
                  </div>
                }
              </div>
            </div>
          </div>
        </form>

        <!-- Right Panel - Document Information -->
        <div class="document-info-panel">
          <h3 class="panel-title" [class.arabic-font]="isRTL">
            {{ "documents.edit.documentInformation" | translate }}
          </h3>

          <div class="info-content">
            <div class="info-item">
              <span class="info-label">{{ "documents.form.department" | translate }}:</span>
              <span class="info-value">{{ getDepartmentName(currentDocument?.department?.toString() || '') }}</span>
            </div>

            <div class="info-item">
              <span class="info-label">{{ "documents.edit.uploadDate" | translate }}:</span>
              <span class="info-value">{{ currentDocument?.uploadDate | date:'M/d/yyyy, h:mm:ss a' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
